<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>ClapTrap - DÃ©tection d'Applaudissements</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.ico') }}">
</head>

<body>
    <header>
        <img src="{{ url_for('static', filename='img/logo.webp') }}" alt="Logo ClapTrap" id="logo">
        <h1>ClapTrap</h1>
    </header>

    <div id="notification" class="notification" style="display: none;"></div>

    <main class="dashboard">
        <!-- Panneau de visualisation -->
        <section class="visualization-panel">
            <div id="detection_display"></div>
            <div class="control-panel">
                <button id="startButton" class="btn btn-primary">DÃ©marrer la dÃ©tection</button>
                <button id="stopButton" class="btn btn-danger" style="display: none;">ArrÃªter la dÃ©tection</button>
            </div>
            <div id="detected_labels" class="labels-container"></div>
        </section>

        <!-- Configuration des sources -->
        <section class="config-panel">
            <h2>Configuration</h2>
            
            <!-- ParamÃ¨tres de dÃ©tection -->
            <div class="config-card">
                <h3>ParamÃ¨tres de dÃ©tection</h3>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="threshold">PrÃ©cision</label>
                        <div class="setting-control">
                            <input type="range" id="threshold" name="threshold" 
                                   min="0" max="1" step="0.1" 
                                   value="{{ settings.get('threshold', 0.5) }}">
                            <output for="threshold">{{ settings.get('threshold', 0.5) }}</output>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="delay">DÃ©lai entre dÃ©tections</label>
                        <div class="setting-control">
                            <input type="number" id="delay" name="delay" 
                                   min="0" step="0.1" value="{{ settings.get('delay', 1.0) }}">
                            <span class="unit">sec</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration des webhooks -->
            <div class="config-card webhooks">
                <h3>Webhooks</h3>
                <div class="webhook-grid">
                    <!-- Webhook Microphone -->
                    <div class="webhook-card">
                        <div class="webhook-header">
                            <h4>
                                <span class="webhook-icon">ðŸŽ¤</span>
                                Microphone
                            </h4>
                            <label class="switch" title="Activer/DÃ©sactiver le webhook">
                                <input type="checkbox" id="webhook-mic-enabled" 
                                       {% if settings.microphone.webhook_url %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="webhook-content" {% if not settings.microphone.webhook_url %}style="display: none;"{% endif %}>
                            <div class="webhook-input-group mb-3">
                                <input type="url" id="webhook-mic-url" 
                                       class="webhook-input" 
                                       value="{{ settings.microphone.webhook_url }}"
                                       placeholder="https://votre-serveur.com/webhook"
                                       aria-label="URL du webhook pour le microphone">
                                <button type="button" class="test-webhook" data-source="microphone">
                                    <span class="icon">ðŸ””</span>
                                    Tester
                                </button>
                            </div>
                            <div class="source-selector">
                                <label for="micro_source">Source Audio :</label>
                                <select name="micro_source" id="micro_source" class="form-select">
                                    {% for device in devices %}
                                    <option value="{{ device.index }}|{{ device.name }}" 
                                            {% if device.name == settings.microphone.audio_source %}selected{% endif %}>
                                        {{ device.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="microphone-section">
                                <div class="clap-indicator">
                                    <i class="fas fa-hands clap-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Webhook VBAN -->
                    <div class="webhook-card">
                        <div class="card-header">
                            <h4>
                                <span class="webhook-icon">ðŸŽµ</span>
                                Sources VBAN
                            </h4>
                            <button id="refreshVBAN" class="refresh-btn">
                                <img src="{{ url_for('static', filename='img/refresh.svg') }}" alt="RafraÃ®chir">
                            </button>
                        </div>
                        <div class="webhook-content">
                            <div id="vbanSourcesList" class="vban-sources-list">
                                <p class="no-sources">Chargement des sources VBAN...</p>
                            </div>
                            <select id="vbanSourceSelect" class="vban-select" style="display: none;">
                                <!-- Les sources seront ajoutÃ©es ici dynamiquement -->
                            </select>
                        </div>
                    </div>

                    <!-- Webhooks RTSP -->
                    {% for stream in flux %}
                    <div class="webhook-card">
                        <div class="webhook-header">
                            <h4>
                                <span class="webhook-icon">ðŸ“¹</span>
                                {{ stream.name }}
                            </h4>
                            <label class="switch" title="Activer/DÃ©sactiver le webhook">
                                <input type="checkbox" id="webhook-rtsp-{{ loop.index }}-enabled" 
                                       {% if stream.webhook_url %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="webhook-content" {% if not stream.webhook_url %}style="display: none;"{% endif %}>
                            <div class="webhook-input-group">
                                <input type="url" id="webhook-rtsp-{{ loop.index }}-url" 
                                       class="webhook-input" 
                                       value="{{ stream.webhook_url }}"
                                       placeholder="https://votre-serveur.com/webhook"
                                       aria-label="URL du webhook pour {{ stream.name }}">
                                <button type="button" class="test-webhook" data-source="rtsp-{{ loop.index }}">
                                    <span class="icon">ðŸ””</span>
                                    Tester
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    </main>

    <footer>
        {% if debug %}
        <p><a href="#" onclick="runTests(); return false;">ExÃ©cuter les tests</a> | <a href="https://korben.info">Un projet de Korben & des FrÃ¨res Poulain</a></p>
        {% else %}
        <p><a href="https://korben.info">Un projet de Korben & des FrÃ¨res Poulain</a></p>
        {% endif %}
    </footer>

    <!-- Charger Socket.IO avant notre script -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>

