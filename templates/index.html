<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>ClapTrap - D√©tection d'Applaudissements</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.ico') }}">
</head>

<body>
    <header>
        <img src="{{ url_for('static', filename='img/logo.webp') }}" alt="Logo ClapTrap" id="logo">
        <h1>ClapTrap</h1>
    </header>

    <div class="notifications">
        <div id="error" class="notification error" style="display: none;"></div>
        <div id="success" class="notification success" style="display: none;"></div>
    </div>

    <main class="dashboard">
        <!-- Panneau de visualisation -->
        <section class="visualization-panel">
            <div id="detection_display"></div>
            <div class="control-panel">
                <button id="startButton" class="btn btn-primary">D√©marrer la d√©tection</button>
                <button id="stopButton" class="btn btn-danger" style="display: none;">Arr√™ter la d√©tection</button>
            </div>
            <div id="detected_labels" class="labels-container"></div>
        </section>

        <!-- Configuration des sources -->
        <section class="config-panel">
            <h2>Configuration</h2>
            
            <!-- Param√®tres de d√©tection -->
            <div class="config-card">
                <h3>Param√®tres de d√©tection</h3>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="threshold">Pr√©cision</label>
                        <input type="range" id="threshold" min="0" max="1" step="0.1" value="{{ settings['global']['threshold'] }}">
                        <span id="threshold-value">{{ settings['global']['threshold'] }}</span>
                    </div>
                    <div class="setting-item">
                        <label for="delay">D√©lai entre d√©tections</label>
                        <div class="setting-control">
                            <input type="number" id="delay" name="delay" 
                                   min="0" step="0.1" value="{{ settings.get('delay', 1.0) }}">
                            <span class="unit">sec</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration des webhooks -->
            <div class="config-card webhooks">
                <h3>Webhooks</h3>
                <div class="webhook-grid">
                    <!-- Webhook Microphone -->
                    <div class="webhook-card">
                        <div class="webhook-header">
                            <h4>
                                <span class="webhook-icon">üé§</span>
                                Microphone
                            </h4>
                            <label class="switch" title="Activer/D√©sactiver le webhook">
                                <input type="checkbox" id="webhook-mic-enabled" 
                                       {% if settings.microphone.webhook_url %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="webhook-content" {% if not settings.microphone.webhook_url %}style="display: none;"{% endif %}>
                            <div class="webhook-input-group mb-3">
                                <input type="url" id="webhook-mic-url" 
                                       class="webhook-input" 
                                       value="{{ settings.microphone.webhook_url }}"
                                       placeholder="https://votre-serveur.com/webhook"
                                       aria-label="URL du webhook pour le microphone">
                                <button type="button" class="test-webhook" data-source="microphone">
                                    <span class="icon">üîî</span>
                                    Tester
                                </button>
                            </div>
                            <div class="source-selector">
                                <label for="micro_source">Source Audio :</label>
                                <select name="micro_source" id="micro_source" class="form-select">
                                    {% for device in devices %}
                                    <option value="{{ device.index }}|{{ device.name }}" 
                                            {% if device.name == settings.microphone.audio_source %}selected{% endif %}>
                                        {{ device.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="microphone-section">
                                <div class="clap-indicator">
                                    <i class="fas fa-hands clap-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Webhook VBAN -->
                    <div class="webhook-card">
                        <div class="card-header">
                            <h4>
                                <span class="webhook-icon">üéµ</span>
                                Sources VBAN
                            </h4>
                            <button id="refreshVBANBtn" class="refresh-btn">
                                <img src="{{ url_for('static', filename='img/refresh.svg') }}" alt="Rafra√Æchir">
                            </button>
                        </div>
                        <div class="webhook-content">
                            <!-- Sources d√©tect√©es -->
                            <div class="vban-section">
                                <h5>Sources d√©tect√©es</h5>
                                <div id="detectedVBANSources" class="list-group mb-3">
                                    <div class="list-group-item text-muted">Aucune source VBAN d√©tect√©e</div>
                                </div>
                            </div>
                            
                            <!-- Sources sauvegard√©es -->
                            <div class="vban-section">
                                <h5>Sources configur√©es</h5>
                                <div id="savedVBANSources" class="list-group">
                                    <div class="list-group-item text-muted">Aucune source VBAN configur√©e</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Webhooks RTSP -->
                    {% for stream in flux %}
                    <div class="webhook-card">
                        <div class="webhook-header">
                            <h4>
                                <span class="webhook-icon">üìπ</span>
                                {{ stream.name }}
                            </h4>
                            <label class="switch" title="Activer/D√©sactiver le webhook">
                                <input type="checkbox" id="webhook-rtsp-{{ loop.index }}-enabled" 
                                       {% if stream.webhook_url %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="webhook-content" {% if not stream.webhook_url %}style="display: none;"{% endif %}>
                            <div class="webhook-input-group">
                                <input type="url" id="webhook-rtsp-{{ loop.index }}-url" 
                                       class="webhook-input" 
                                       value="{{ stream.webhook_url }}"
                                       placeholder="https://votre-serveur.com/webhook"
                                       aria-label="URL du webhook pour {{ stream.name }}">
                                <button type="button" class="test-webhook" data-source="rtsp-{{ loop.index }}">
                                    <span class="icon">üîî</span>
                                    Tester
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    </main>

    <footer>
        {% if debug %}
        <p><a href="#" onclick="runTests(); return false;">Ex√©cuter les tests</a> | <a href="https://korben.info">Un projet de Korben & des Fr√®res Poulain</a></p>
        {% else %}
        <p><a href="https://korben.info">Un projet de Korben & des Fr√®res Poulain</a></p>
        {% endif %}
    </footer>

    <!-- Charger Socket.IO avant notre script -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    
    <!-- Initialiser les settings avant le script principal -->
    <script type="text/javascript">
        window.settings = JSON.parse('{{ settings_json|safe }}');
    </script>
    
    <!-- Charger notre script principal -->
    <script type="module" src="{{ url_for('static', filename='js/script.js') }}"></script>

    <template id="vbanDetectedSourceTemplate">
        <div class="webhook-card mb-3">
            <div class="webhook-header">
                <h4>
                    <span class="webhook-icon">üéµ</span>
                    <span class="source-name"></span>
                </h4>
                <div class="webhook-actions">
                    <button class="btn btn-sm btn-success add-vban-btn">
                        <span>‚ûï</span> Ajouter
                    </button>
                </div>
            </div>
            <div class="webhook-content">
                <div class="webhook-input-group mb-3">
                    <label class="form-label">Adresse IP</label>
                    <div class="info-text source-ip"></div>
                </div>
                <div class="webhook-input-group mb-3">
                    <label class="form-label">Port</label>
                    <div class="info-text source-port"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="vbanSavedSourceTemplate">
        <div class="webhook-card mb-3">
            <div class="webhook-header">
                <h4>
                    <span class="webhook-icon">üéµ</span>
                    <span class="source-name"></span>
                </h4>
                <label class="switch" title="Activer/D√©sactiver la source">
                    <input type="checkbox" class="source-enabled">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="webhook-content">
                <div class="webhook-input-group mb-3">
                    <label class="form-label">Adresse IP</label>
                    <div class="info-text source-ip"></div>
                </div>
                <div class="webhook-input-group mb-3">
                    <label class="form-label">Port</label>
                    <div class="info-text source-port"></div>
                </div>
                <div class="webhook-input-group">
                    <label class="form-label">URL Webhook</label>
                    <div class="webhook-input-with-test">
                        <input type="url" class="webhook-input webhook-url" 
                               placeholder="https://votre-serveur.com/webhook">
                        <button type="button" class="test-webhook">
                            <span class="icon">üîî</span>
                            Tester
                        </button>
                    </div>
                </div>
                <div class="webhook-actions mt-3">
                    <button class="btn btn-sm btn-danger remove-vban-btn">
                        <span>üóëÔ∏è</span> Supprimer
                    </button>
                </div>
            </div>
        </div>
    </template>
</body>
</html>

