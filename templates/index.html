<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>ClapTrap - DÃ©tection d'Applaudissements</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.ico') }}">
</head>

<body>
    <header>
        <img src="{{ url_for('static', filename='img/logo.webp') }}" alt="Logo ClapTrap" id="logo">
        <h1>ClapTrap</h1>
    </header>

    <div id="notification" class="notification" style="display: none;"></div>

    <main class="dashboard">
        <!-- Panneau de visualisation -->
        <section class="visualization-panel">
            <div id="detection_display"></div>
            <div class="control-panel">
                <button id="startButton" class="btn btn-primary">DÃ©marrer la dÃ©tection</button>
                <button id="stopButton" class="btn btn-danger" style="display: none;">ArrÃªter la dÃ©tection</button>
            </div>
            <div id="detected_labels"></div>
        </section>

        <!-- Configuration des sources -->
        <section class="config-panel">
            <h2>Configuration</h2>
            
            <!-- SÃ©lection de la source -->
            <div class="config-card">
                <h3>Source Audio</h3>
                <div class="source-selector">
                    <select name="audio_source" id="audio_source" aria-label="SÃ©lection de la source audio">
                        <optgroup label="Microphones">
                            {% for device in devices %}
                            <option value="{{ device['name'] }}" {% if device['name'] == settings.audio_source %}selected{% endif %}>
                                {{ device['name'] }}
                            </option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Flux RTSP">
                            {% for stream in flux %}
                            <option value="{{ stream['url'] }}" {% if stream['url'] == settings.audio_source %}selected{% endif %}>
                                {{ stream['name'] }}
                            </option>
                            {% endfor %}
                        </optgroup>
                    </select>
                    <button type="button" id="refresh_vban" class="refresh-button" aria-label="RafraÃ®chir les sources VBAN">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- ParamÃ¨tres de dÃ©tection -->
            <div class="config-card">
                <h3>ParamÃ¨tres de dÃ©tection</h3>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="threshold">PrÃ©cision</label>
                        <div class="setting-control">
                            <input type="range" id="threshold" name="threshold" 
                                   min="0" max="1" step="0.1" 
                                   value="{{ settings.get('threshold', 0.5) }}">
                            <output for="threshold">{{ settings.get('threshold', 0.5) }}</output>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="delay">DÃ©lai entre dÃ©tections</label>
                        <div class="setting-control">
                            <input type="number" id="delay" name="delay" 
                                   min="0" step="0.1" value="{{ settings.get('delay', 1.0) }}">
                            <span class="unit">sec</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration des webhooks -->
            <div class="config-card webhooks">
                <h3>Webhooks</h3>
                <div class="webhook-grid">
                    <!-- Webhook Microphone -->
                    <div class="webhook-card">
                        <div class="webhook-header">
                            <h4>
                                <span class="webhook-icon">ðŸŽ¤</span>
                                Microphone
                            </h4>
                            <label class="switch" title="Activer/DÃ©sactiver le webhook">
                                <input type="checkbox" id="webhook-mic-enabled" 
                                       {% if settings.microphone.webhook_url %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="webhook-content" {% if not settings.microphone.webhook_url %}style="display: none;"{% endif %}>
                            <div class="webhook-input-group">
                                <input type="url" id="webhook-mic-url" 
                                       class="webhook-input" 
                                       value="{{ settings.microphone.webhook_url }}"
                                       placeholder="https://votre-serveur.com/webhook"
                                       aria-label="URL du webhook pour le microphone">
                                <button type="button" class="test-webhook" data-source="microphone">
                                    <span class="icon">ðŸ””</span>
                                    Tester
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Webhooks RTSP -->
                    {% for stream in flux %}
                    <div class="webhook-card">
                        <div class="webhook-header">
                            <h4>
                                <span class="webhook-icon">ðŸ“¹</span>
                                {{ stream.name }}
                            </h4>
                            <label class="switch" title="Activer/DÃ©sactiver le webhook">
                                <input type="checkbox" id="webhook-rtsp-{{ loop.index }}-enabled" 
                                       {% if stream.webhook_url %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="webhook-content" {% if not stream.webhook_url %}style="display: none;"{% endif %}>
                            <div class="webhook-input-group">
                                <input type="url" id="webhook-rtsp-{{ loop.index }}-url" 
                                       class="webhook-input" 
                                       value="{{ stream.webhook_url }}"
                                       placeholder="https://votre-serveur.com/webhook"
                                       aria-label="URL du webhook pour {{ stream.name }}">
                                <button type="button" class="test-webhook" data-source="rtsp-{{ loop.index }}">
                                    <span class="icon">ðŸ””</span>
                                    Tester
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    </main>

    <footer>
        {% if debug %}
        <p><a href="#" onclick="runTests(); return false;">ExÃ©cuter les tests</a> | <a href="https://korben.info">Un projet de Korben & des FrÃ¨res Poulain</a></p>
        {% else %}
        <p><a href="https://korben.info">Un projet de Korben & des FrÃ¨res Poulain</a></p>
        {% endif %}
    </footer>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</body>
</html>

